<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-koa-generic-session/node_modules/koa-generic-session/lib/session.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-koa-generic-session">npmtest-koa-generic-session (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-koa-generic-session/node_modules/koa-generic-session/lib/session.js</span></h1>
    <h2>
        
        Statements: <span class="metric">10.55% <small>(23 / 218)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 103)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 28)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">10.85% <small>(23 / 212)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-koa-generic-session/node_modules/koa-generic-session/lib/</a> &#187; session.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**!
 * koa-generic-session - lib/session.js
 * Copyright(c) 2013 - 2014
 * MIT Licensed
 *
 * Authors:
 *   dead_horse &lt;dead_horse@qq.com&gt; (http://deadhorse.me)
 */
&nbsp;
'use strict';
&nbsp;
/**
 * Module dependencies.
 */
&nbsp;
const debug = require('debug')('koa-generic-session:session');
const MemoryStore = require('./memory_store');
const crc32 = require('crc').crc32;
const parse = require('parseurl');
const Store = require('./store');
const copy = require('copy-to');
const uid = require('uid-safe');
&nbsp;
/**
 * Warning message for `MemoryStore` usage in production.
 */
&nbsp;
const warning = 'Warning: koa-generic-session\'s MemoryStore is not\n' +
  'designed for a production environment, as it will leak\n' +
  'memory, and will not scale past a single process.';
&nbsp;
const defaultCookie = {
  httpOnly: true,
  path: '/',
  overwrite: true,
  signed: true,
  maxAge: 24 * 60 * 60 * 1000 //one day in ms
};
&nbsp;
/**
 * setup session store with the given `options`
 * @param {Object} options
 *   - [`key`] cookie name, defaulting to `koa.sid`
 *   - [`store`] session store instance, default to MemoryStore
 *   - [`ttl`] store ttl in `ms`, default to oneday
 *   - [`prefix`] session prefix for store, defaulting to `koa:sess:`
 *   - [`cookie`] session cookie settings, defaulting to
 *     {path: '/', httpOnly: true, maxAge: null, rewrite: true, signed: true}
 *   - [`defer`] defer get session,
 *   - [`rolling`]  rolling session, always reset the cookie and sessions, default is false
 *     you should `yield this.session` to get the session if defer is true, default is false
 *   - [`genSid`] you can use your own generator for sid
 *   - [`errorHanlder`] handler for session store get or set error
 *   - [`valid`] valid(ctx, session), valid session value before use it
 *   - [`beforeSave`] beforeSave(ctx, session), hook before save session
 *   - [`sessionIdStore`] object with get, set, reset methods for passing session id throw requests.
 */
&nbsp;
module.exports = <span class="fstat-no" title="function not covered" >function (options) {</span>
<span class="cstat-no" title="statement not covered" >  options = options || {};</span>
<span class="cstat-no" title="statement not covered" >  let key = options.key || 'koa.sid';</span>
<span class="cstat-no" title="statement not covered" >  let client = options.store || new MemoryStore();</span>
<span class="cstat-no" title="statement not covered" >  let errorHandler = options.errorHandler || defaultErrorHanlder;</span>
<span class="cstat-no" title="statement not covered" >  let reconnectTimeout = options.reconnectTimeout || 10000;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  let store = new Store(client, {</span>
    ttl: options.ttl,
    prefix: options.prefix
  });
&nbsp;
<span class="cstat-no" title="statement not covered" >  let genSid = options.genSid || uid.sync;</span>
<span class="cstat-no" title="statement not covered" >  let valid = options.valid || noop;</span>
<span class="cstat-no" title="statement not covered" >  let beforeSave = options.beforeSave || noop;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  let cookie = options.cookie || {};</span>
<span class="cstat-no" title="statement not covered" >  copy(defaultCookie).to(cookie);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  let storeStatus = 'available';</span>
<span class="cstat-no" title="statement not covered" >  let waitStore = Promise.resolve();</span>
&nbsp;
  // notify user that this store is not
  // meant for a production environment
<span class="cstat-no" title="statement not covered" >  if ('production' === process.env.NODE_ENV</span>
   &amp;&amp; client instanceof MemoryStore) <span class="cstat-no" title="statement not covered" >console.warn(warning);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  let sessionIdStore = options.sessionIdStore || {</span>
&nbsp;
    get: <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >      return this.cookies.get(key, cookie);</span>
    },
&nbsp;
    set: <span class="fstat-no" title="function not covered" >function(sid, session) {</span>
<span class="cstat-no" title="statement not covered" >      this.cookies.set(key, sid, session.cookie);</span>
    },
&nbsp;
    reset: <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >      this.cookies.set(key, null);</span>
    }
  };
&nbsp;
<span class="cstat-no" title="statement not covered" >  store.on('disconnect', <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >    if (storeStatus !== 'available') <span class="cstat-no" title="statement not covered" >return;</span></span>
<span class="cstat-no" title="statement not covered" >    storeStatus = 'pending';</span>
<span class="cstat-no" title="statement not covered" >    waitStore = new Promise(<span class="fstat-no" title="function not covered" >function (resolve, reject) {</span></span>
<span class="cstat-no" title="statement not covered" >      setTimeout(<span class="fstat-no" title="function not covered" >function () {</span></span>
<span class="cstat-no" title="statement not covered" >        if (storeStatus === 'pending') <span class="cstat-no" title="statement not covered" >storeStatus = 'unavailable';</span></span>
<span class="cstat-no" title="statement not covered" >        reject(new Error('session store is unavailable'));</span>
      }, reconnectTimeout);
<span class="cstat-no" title="statement not covered" >      store.once('connect', resolve);</span>
    });
&nbsp;
  });
&nbsp;
<span class="cstat-no" title="statement not covered" >  store.on('connect', <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >    storeStatus = 'available';</span>
<span class="cstat-no" title="statement not covered" >    waitStore = Promise.resolve();</span>
  });
&nbsp;
  // save empty session hash for compare
<span class="cstat-no" title="statement not covered" >  const EMPTY_SESSION_HASH = hash(generateSession());</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  return options.defer ? deferSession : session;</span>
&nbsp;
<span class="fstat-no" title="function not covered" >  function addCommonAPI() {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    this._sessionSave = null;</span>
&nbsp;
    // more flexible
<span class="cstat-no" title="statement not covered" >    this.__defineGetter__('sessionSave', <span class="fstat-no" title="function not covered" >function () {</span></span>
<span class="cstat-no" title="statement not covered" >      return this._sessionSave;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.__defineSetter__('sessionSave', <span class="fstat-no" title="function not covered" >function (save) {</span></span>
<span class="cstat-no" title="statement not covered" >      this._sessionSave = save;</span>
    });
  }
&nbsp;
  /**
   * generate a new session
   */
<span class="fstat-no" title="function not covered" >  function generateSession() {</span>
<span class="cstat-no" title="statement not covered" >    let session = {};</span>
    //you can alter the cookie options in nexts
<span class="cstat-no" title="statement not covered" >    session.cookie = {};</span>
<span class="cstat-no" title="statement not covered" >    for (let prop in cookie) {</span>
<span class="cstat-no" title="statement not covered" >      session.cookie[prop] = cookie[prop];</span>
    }
<span class="cstat-no" title="statement not covered" >    compatMaxage(session.cookie);</span>
<span class="cstat-no" title="statement not covered" >    return session;</span>
  }
&nbsp;
  /**
   * check url match cookie's path
   */
<span class="fstat-no" title="function not covered" >  function matchPath(ctx) {</span>
<span class="cstat-no" title="statement not covered" >    let pathname = parse(ctx).pathname;</span>
<span class="cstat-no" title="statement not covered" >    let cookiePath = cookie.path || '/';</span>
<span class="cstat-no" title="statement not covered" >    if (cookiePath === '/') {</span>
<span class="cstat-no" title="statement not covered" >      return true;</span>
    }
<span class="cstat-no" title="statement not covered" >    if (pathname.indexOf(cookiePath) !== 0) {</span>
<span class="cstat-no" title="statement not covered" >      debug('cookie path not match');</span>
<span class="cstat-no" title="statement not covered" >      return false;</span>
    }
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
  /**
   * get session from store
   *   get sessionId from cookie
   *   save sessionId into context
   *   get session from store
   */
<span class="fstat-no" title="function not covered" >  function *getSession() {</span>
<span class="cstat-no" title="statement not covered" >    if (!matchPath(this)) <span class="cstat-no" title="statement not covered" >return;</span></span>
<span class="cstat-no" title="statement not covered" >    if (storeStatus === 'pending') {</span>
<span class="cstat-no" title="statement not covered" >      debug('store is disconnect and pending');</span>
<span class="cstat-no" title="statement not covered" >      yield waitStore;</span>
    } else <span class="cstat-no" title="statement not covered" >if (storeStatus === 'unavailable') {</span>
<span class="cstat-no" title="statement not covered" >      debug('store is unavailable');</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('session store is unavailable');</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!this.sessionId) {</span>
<span class="cstat-no" title="statement not covered" >      this.sessionId = sessionIdStore.get.call(this);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    let session;</span>
<span class="cstat-no" title="statement not covered" >    let isNew = false;</span>
<span class="cstat-no" title="statement not covered" >    if (!this.sessionId) {</span>
<span class="cstat-no" title="statement not covered" >      debug('session id not exist, generate a new one');</span>
<span class="cstat-no" title="statement not covered" >      session = generateSession();</span>
<span class="cstat-no" title="statement not covered" >      this.sessionId = genSid.call(this, 24);</span>
<span class="cstat-no" title="statement not covered" >      isNew = true;</span>
    } else {
<span class="cstat-no" title="statement not covered" >      try {</span>
<span class="cstat-no" title="statement not covered" >        session = yield store.get(this.sessionId);</span>
<span class="cstat-no" title="statement not covered" >        debug('get session %j with key %s', session, this.sessionId);</span>
      } catch (err) {
<span class="cstat-no" title="statement not covered" >        if (err.code === 'ENOENT') {</span>
<span class="cstat-no" title="statement not covered" >          debug('get session error, code = ENOENT');</span>
        } else {
<span class="cstat-no" title="statement not covered" >          debug('get session error: ', err.message);</span>
<span class="cstat-no" title="statement not covered" >          errorHandler(err, 'get', this);</span>
        }
      }
    }
&nbsp;
    // make sure the session is still valid
<span class="cstat-no" title="statement not covered" >    if (!session ||</span>
      !valid(this, session)) {
<span class="cstat-no" title="statement not covered" >      debug('session is empty or invalid');</span>
<span class="cstat-no" title="statement not covered" >      session = generateSession();</span>
<span class="cstat-no" title="statement not covered" >      this.sessionId = genSid.call(this, 24);</span>
<span class="cstat-no" title="statement not covered" >      sessionIdStore.reset.call(this);</span>
<span class="cstat-no" title="statement not covered" >      isNew = true;</span>
    }
&nbsp;
    // get the originHash
<span class="cstat-no" title="statement not covered" >    let originalHash = !isNew &amp;&amp; hash(session);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return {</span>
      originalHash: originalHash,
      session: session,
      isNew: isNew
    };
  }
&nbsp;
  /**
   * after everything done, refresh the session
   *   if session === null; delete it from store
   *   if session is modified, update cookie and store
   */
<span class="fstat-no" title="function not covered" >  function *refreshSession (session, originalHash, isNew) {</span>
&nbsp;
    // reject any session changes, and do not update session expiry
<span class="cstat-no" title="statement not covered" >    if(this._sessionSave === false) {</span>
<span class="cstat-no" title="statement not covered" >      return debug('session save disabled');</span>
    }
&nbsp;
    //delete session
<span class="cstat-no" title="statement not covered" >    if (!session) {</span>
<span class="cstat-no" title="statement not covered" >      if (!isNew) {</span>
<span class="cstat-no" title="statement not covered" >        debug('session set to null, destroy session: %s', this.sessionId);</span>
<span class="cstat-no" title="statement not covered" >        sessionIdStore.reset.call(this);</span>
<span class="cstat-no" title="statement not covered" >        return yield store.destroy(this.sessionId);</span>
      }
<span class="cstat-no" title="statement not covered" >      return debug('a new session and set to null, ignore destroy');</span>
    }
&nbsp;
    // force saving non-empty session
<span class="cstat-no" title="statement not covered" >    if(this._sessionSave === true) {</span>
<span class="cstat-no" title="statement not covered" >      debug('session save forced');</span>
<span class="cstat-no" title="statement not covered" >      return yield saveNow.call(this, this.sessionId, session);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    let newHash = hash(session);</span>
    // if new session and not modified, just ignore
<span class="cstat-no" title="statement not covered" >    if (!options.allowEmpty &amp;&amp; isNew &amp;&amp; newHash === EMPTY_SESSION_HASH) {</span>
<span class="cstat-no" title="statement not covered" >      return debug('new session and do not modified');</span>
    }
&nbsp;
    // rolling session will always reset cookie and session
<span class="cstat-no" title="statement not covered" >    if (!options.rolling &amp;&amp; newHash === originalHash) {</span>
<span class="cstat-no" title="statement not covered" >      return debug('session not modified');</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    debug('session modified');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    yield saveNow.call(this, this.sessionId, session);</span>
&nbsp;
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function *saveNow(id, session) {</span>
<span class="cstat-no" title="statement not covered" >    compatMaxage(session.cookie);</span>
&nbsp;
    // custom before save hook
<span class="cstat-no" title="statement not covered" >    beforeSave(this, session);</span>
&nbsp;
    //update session
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      yield store.set(id, session);</span>
<span class="cstat-no" title="statement not covered" >      sessionIdStore.set.call(this, id, session);</span>
<span class="cstat-no" title="statement not covered" >      debug('saved');</span>
    } catch (err) {
<span class="cstat-no" title="statement not covered" >      debug('set session error: ', err.message);</span>
<span class="cstat-no" title="statement not covered" >      errorHandler(err, 'set', this);</span>
    }
  }
&nbsp;
  /**
   * common session middleware
   * each request will generate a new session
   *
   * ```
   * let session = this.session;
   * ```
   */
<span class="fstat-no" title="function not covered" >  function *session(next) {</span>
<span class="cstat-no" title="statement not covered" >    this.sessionStore = store;</span>
<span class="cstat-no" title="statement not covered" >    if (this.session || this._session) {</span>
<span class="cstat-no" title="statement not covered" >      return yield next;</span>
    }
<span class="cstat-no" title="statement not covered" >    let result = yield getSession.call(this);</span>
<span class="cstat-no" title="statement not covered" >    if (!result) {</span>
<span class="cstat-no" title="statement not covered" >      return yield next;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    addCommonAPI.call(this);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    this._session = result.session;</span>
&nbsp;
    // more flexible
<span class="cstat-no" title="statement not covered" >    this.__defineGetter__('session', <span class="fstat-no" title="function not covered" >function () {</span></span>
<span class="cstat-no" title="statement not covered" >      return this._session;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.__defineSetter__('session', <span class="fstat-no" title="function not covered" >function (sess) {</span></span>
<span class="cstat-no" title="statement not covered" >      this._session = sess;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.regenerateSession = <span class="fstat-no" title="function not covered" >function *regenerateSession() {</span></span>
<span class="cstat-no" title="statement not covered" >      debug('regenerating session');</span>
<span class="cstat-no" title="statement not covered" >      if (!result.isNew) {</span>
        // destroy the old session
<span class="cstat-no" title="statement not covered" >        debug('destroying previous session');</span>
<span class="cstat-no" title="statement not covered" >        yield store.destroy(this.sessionId);</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      this.session = generateSession();</span>
<span class="cstat-no" title="statement not covered" >      this.sessionId = genSid.call(this, 24);</span>
<span class="cstat-no" title="statement not covered" >      sessionIdStore.reset.call(this);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      debug('created new session: %s', this.sessionId);</span>
<span class="cstat-no" title="statement not covered" >      result.isNew = true;</span>
    }
&nbsp;
    // make sure `refreshSession` always called
<span class="cstat-no" title="statement not covered" >    var firstError = null;</span>
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      yield next;</span>
    } catch (err) {
<span class="cstat-no" title="statement not covered" >      debug('next logic error: %s', err.message);</span>
<span class="cstat-no" title="statement not covered" >      firstError = err;</span>
    }
    // can't use finally because `refreshSession` is async
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      yield refreshSession.call(this, this.session, result.originalHash, result.isNew);</span>
    } catch (err) {
<span class="cstat-no" title="statement not covered" >      debug('refresh session error: %s', err.message);</span>
<span class="cstat-no" title="statement not covered" >      if (firstError) <span class="cstat-no" title="statement not covered" >this.app.emit('error', err, this);</span></span>
<span class="cstat-no" title="statement not covered" >      firstError = firstError || err;</span>
    }
<span class="cstat-no" title="statement not covered" >    if (firstError) <span class="cstat-no" title="statement not covered" >throw firstError;</span></span>
  }
&nbsp;
  /**
   * defer session middleware
   * only generate and get session when request use session
   *
   * ```
   * let session = yield this.session;
   * ```
   */
<span class="fstat-no" title="function not covered" >  function *deferSession(next) {</span>
<span class="cstat-no" title="statement not covered" >    this.sessionStore = store;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (this.session) {</span>
<span class="cstat-no" title="statement not covered" >      return yield next;</span>
    }
<span class="cstat-no" title="statement not covered" >    let isNew = false;</span>
<span class="cstat-no" title="statement not covered" >    let originalHash = null;</span>
<span class="cstat-no" title="statement not covered" >    let touchSession = false;</span>
<span class="cstat-no" title="statement not covered" >    let getter = false;</span>
&nbsp;
    // if path not match
<span class="cstat-no" title="statement not covered" >    if (!matchPath(this)) {</span>
<span class="cstat-no" title="statement not covered" >      return yield next;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    addCommonAPI.call(this);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.__defineGetter__('session', <span class="fstat-no" title="function not covered" >function *() {</span></span>
<span class="cstat-no" title="statement not covered" >      if (touchSession) {</span>
<span class="cstat-no" title="statement not covered" >        return this._session;</span>
      }
<span class="cstat-no" title="statement not covered" >      touchSession = true;</span>
<span class="cstat-no" title="statement not covered" >      getter = true;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      let result = yield getSession.call(this);</span>
      // if cookie path not match
      // this route's controller should never use session
<span class="cstat-no" title="statement not covered" >      if (!result) <span class="cstat-no" title="statement not covered" >return;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      originalHash = result.originalHash;</span>
<span class="cstat-no" title="statement not covered" >      isNew = result.isNew;</span>
<span class="cstat-no" title="statement not covered" >      this._session = result.session;</span>
<span class="cstat-no" title="statement not covered" >      return this._session;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.__defineSetter__('session', <span class="fstat-no" title="function not covered" >function (value) {</span></span>
<span class="cstat-no" title="statement not covered" >      touchSession = true;</span>
<span class="cstat-no" title="statement not covered" >      this._session = value;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.regenerateSession = <span class="fstat-no" title="function not covered" >function *regenerateSession() {</span></span>
<span class="cstat-no" title="statement not covered" >      debug('regenerating session');</span>
      // make sure that the session has been loaded
<span class="cstat-no" title="statement not covered" >      yield this.session;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (!isNew) {</span>
        // destroy the old session
<span class="cstat-no" title="statement not covered" >        debug('destroying previous session');</span>
<span class="cstat-no" title="statement not covered" >        yield store.destroy(this.sessionId);</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      this._session = generateSession();</span>
<span class="cstat-no" title="statement not covered" >      this.sessionId = genSid.call(this, 24);</span>
<span class="cstat-no" title="statement not covered" >      sessionIdStore.reset.call(this);</span>
<span class="cstat-no" title="statement not covered" >      debug('created new session: %s', this.sessionId);</span>
<span class="cstat-no" title="statement not covered" >      isNew = true;</span>
<span class="cstat-no" title="statement not covered" >      return this._session;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    yield next;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (touchSession) {</span>
      // if only this.session=, need try to decode and get the sessionID
<span class="cstat-no" title="statement not covered" >      if (!getter) {</span>
<span class="cstat-no" title="statement not covered" >        this.sessionId = sessionIdStore.get.call(this);</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      yield refreshSession.call(this, this._session, originalHash, isNew);</span>
    }
  }
};
&nbsp;
/**
 * get the hash of a session include cookie options.
 */
<span class="fstat-no" title="function not covered" >function hash(sess) {</span>
<span class="cstat-no" title="statement not covered" >  return crc32.signed(JSON.stringify(sess));</span>
}
&nbsp;
/**
 * cookie use maxAge, hack to compat connect type `maxage`
 */
<span class="fstat-no" title="function not covered" >function compatMaxage(opts) {</span>
<span class="cstat-no" title="statement not covered" >  if (opts) {</span>
<span class="cstat-no" title="statement not covered" >    opts.maxAge = opts.maxage ? opts.maxage : opts.maxAge;</span>
<span class="cstat-no" title="statement not covered" >    delete opts.maxage;</span>
  }
}
&nbsp;
module.exports.MemoryStore = MemoryStore;
&nbsp;
<span class="fstat-no" title="function not covered" >function defaultErrorHanlder (err, type, ctx) {</span>
<span class="cstat-no" title="statement not covered" >  err.name = 'koa-generic-session ' + type + ' error';</span>
<span class="cstat-no" title="statement not covered" >  throw err;</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function noop () {</span>
<span class="cstat-no" title="statement not covered" >  return true;</span>
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Thu Apr 20 2017 19:29:21 GMT+0000 (UTC)</div>
</div>
</body>
</html>
